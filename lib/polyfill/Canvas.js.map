{"version":3,"sources":["../../src/polyfill/Canvas.js"],"names":["PSCanvas","Canvas","constructor","width","height","type","_event","EventEmitter","_glResizeExt","_gl","_renderType","useTypedArray","isPSCanvas","id","getContext","options","ctx","GLFix","fixGetUniformLocation","fixTexImage2D","getExtension","_ctx","value","resize","clientWidth","clientHeight","addEventListener","listener","addListener","removeEventListener","removeListener","removeAllListeners","_putImageData","data","pixels","Uint8Array","readPixels","RGBA","UNSIGNED_BYTE","Uint8ClampedArray","getImageData","_fillImageData","putImageData","i","j","col","row","k","idx","idx2","toBuffer","toDataURL","createPNGStream","createJPEGStream","createPDFStream","destroy"],"mappings":"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","sourcesContent":["import { gl, Canvas, createImageData } from \"../canvas-gl\";\nimport poly from \"./poly\";\nimport GLFix from \"./glfix\";\nimport { uuidvx } from \"../utils\";\nimport EventEmitter from \"eventemitter3\";\n\nexport default class PSCanvas extends poly(Canvas) {\n  constructor(width, height, type) {\n    super(width, height, type);\n\n    this._event = new EventEmitter();\n    this._glResizeExt = null;\n    this._gl = null;\n    this._renderType = \"2d\";\n    this.useTypedArray = false;\n    this.isPSCanvas = true;\n    this.id = uuidvx();\n  }\n\n  // Get canvas context\n  getContext(type, options) {\n    this._renderType = type;\n\n    if (type === \"webgl\") {\n      if (this._gl) return this._gl;\n\n      const { width, height } = this;\n      const ctx = gl(width, height, options);\n      GLFix.fixGetUniformLocation(ctx);\n      GLFix.fixTexImage2D(ctx);\n\n      this._gl = ctx;\n      this._glResizeExt = ctx.getExtension(\"STACKGL_resize_drawingbuffer\");\n      this._ctx = super.getContext(\"2d\", options);\n      return this._gl;\n    }\n\n    return super.getContext(type, options);\n  }\n\n  // Canvas Reset width and height\n  get height() {\n    return super.height;\n  }\n\n  set height(value) {\n    if (this._glResizeExt) this._glResizeExt.resize(this.width, value);\n    super.height = value;\n  }\n\n  get width() {\n    return super.width;\n  }\n\n  set width(value) {\n    if (this._glResizeExt) this._glResizeExt.resize(value, this.height);\n    super.width = value;\n  }\n\n  get clientWidth() {\n    return super.width;\n  }\n\n  get clientHeight() {\n    return super.height;\n  }\n\n  // add and remove event listener\n  addEventListener(type, listener) {\n    return this._event.addListener(type, listener);\n  }\n\n  removeEventListener(type, listener) {\n    if (listener) return this._event.removeListener(type, listener);\n    return this._event.removeAllListeners(type);\n  }\n\n  _putImageData() {\n    let data;\n    const { width, height, _ctx, _gl, useTypedArray } = this;\n    const pixels = new Uint8Array(width * height * 4);\n    _gl.readPixels(0, 0, width, height, _gl.RGBA, _gl.UNSIGNED_BYTE, pixels);\n\n    if (useTypedArray) {\n      data = createImageData(new Uint8ClampedArray(pixels), width, height);\n    } else {\n      data = _ctx.getImageData(0, 0, width, height);\n      this._fillImageData(data, pixels, width, height);\n    }\n\n    _ctx.putImageData(data, 0, 0);\n  }\n\n  _fillImageData(data, pixels, width, height) {\n    for (let i = 0; i < height; i++) {\n      for (let j = 0; j < width; j++) {\n        const col = j;\n        const row = height - i - 1;\n        for (let k = 0; k < 4; k++) {\n          const idx = 4 * (row * width + col) + k;\n          const idx2 = 4 * (i * width + col) + k;\n          data.data[idx] = pixels[idx2];\n        }\n      }\n    }\n\n    return data;\n  }\n\n  // Store buffer png jpg and other data\n  toBuffer(...args) {\n    if (this._gl) this._putImageData();\n    return super.toBuffer(...args);\n  }\n\n  toDataURL(...args) {\n    if (this._gl) this._putImageData();\n    return super.toDataURL(...args);\n  }\n\n  createPNGStream(...args) {\n    if (this._gl) this._putImageData();\n    return super.createPNGStream(...args);\n  }\n\n  createJPEGStream(...args) {\n    if (this._gl) this._putImageData();\n    return super.createJPEGStream(...args);\n  }\n\n  createPDFStream(...args) {\n    if (this._gl) this._putImageData();\n    return super.createPDFStream(...args);\n  }\n\n  destroy() {\n    //super.destroy();\n    this._event.removeAllListeners();\n    this._event = null;\n    this._glResizeExt = null;\n    this._gl = null;\n  }\n}\n"],"file":"Canvas.js"}